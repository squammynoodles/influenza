---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/Gemfile
  - api/config/database.yml
  - api/config/initializers/cors.rb
  - api/app/models/user.rb
  - api/app/models/session.rb
  - api/app/models/current.rb
  - api/app/models/invitation.rb
  - api/app/controllers/concerns/authentication.rb
  - api/app/controllers/application_controller.rb
  - api/app/controllers/api/v1/sessions_controller.rb
  - api/app/controllers/api/v1/users_controller.rb
  - api/app/controllers/api/v1/passwords_controller.rb
  - api/app/controllers/api/v1/invitations_controller.rb
  - api/app/mailers/passwords_mailer.rb
  - api/app/mailers/invitations_mailer.rb
  - api/config/routes.rb
  - api/db/migrate/*
autonomous: true

must_haves:
  truths:
    - "POST /api/v1/sessions with valid credentials returns 200 + token"
    - "POST /api/v1/sessions with invalid credentials returns 401"
    - "Protected endpoints return 401 without Authorization header"
    - "Protected endpoints return user data with valid token"
    - "POST /api/v1/invitations creates invitation and returns token"
    - "POST /api/v1/users with valid invite token creates user"
    - "POST /api/v1/passwords with email triggers reset token generation"
    - "PUT /api/v1/passwords with valid reset token updates password"
  artifacts:
    - path: "api/app/models/user.rb"
      provides: "User model with has_secure_password"
      contains: "has_secure_password"
    - path: "api/app/models/session.rb"
      provides: "Session model with secure token"
      contains: "has_secure_token"
    - path: "api/app/models/invitation.rb"
      provides: "Invitation model with generates_token_for"
      contains: "generates_token_for"
    - path: "api/app/controllers/concerns/authentication.rb"
      provides: "Token-based authentication concern"
      contains: "authenticate_with_http_token"
  key_links:
    - from: "api/app/controllers/api/v1/sessions_controller.rb"
      to: "api/app/models/session.rb"
      via: "session creation on login"
      pattern: "sessions\\.create"
    - from: "api/app/controllers/concerns/authentication.rb"
      to: "api/app/models/session.rb"
      via: "token lookup"
      pattern: "Session\\.find_by.*token"
---

<objective>
Create Rails 8 API backend with complete authentication infrastructure

Purpose: Establish the backend foundation with User model, Session-based token authentication, Invitation system for invite-only access, and Password reset flow. This enables the Next.js frontend to perform all auth operations.

Output:
- Working Rails 8 API application with PostgreSQL
- User, Session, Invitation models with proper relationships
- Token-based authentication (Authorization: Bearer header)
- API versioned endpoints under /api/v1/
- Complete auth flows: login, logout, signup (via invite), password reset
</objective>

<execution_context>
@/Users/superuser/.claude/get-shit-done/workflows/execute-plan.md
@/Users/superuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Rails API project with authentication models</name>
  <files>
    api/Gemfile
    api/config/database.yml
    api/config/initializers/cors.rb
    api/app/models/user.rb
    api/app/models/session.rb
    api/app/models/current.rb
    api/app/models/invitation.rb
    api/db/migrate/*_create_users.rb
    api/db/migrate/*_create_sessions.rb
    api/db/migrate/*_create_invitations.rb
  </files>
  <action>
    1. Create Rails 8 API application:
       ```bash
       rails new api --api --database=postgresql --skip-test --skip-system-test
       cd api
       bundle add rack-cors
       ```

    2. Configure CORS in config/initializers/cors.rb:
       - Allow origins from ENV['FRONTEND_URL'] || 'http://localhost:3001'
       - Allow methods: get, post, put, patch, delete, options, head
       - credentials: true
       - expose: ['Authorization']
       - Insert middleware at position 0: `config.middleware.insert_before 0, Rack::Cors`

    3. Create User model (api/app/models/user.rb):
       - email_address:string (unique, not null)
       - password_digest:string (not null)
       - admin:boolean (default: false)
       - has_secure_password
       - has_many :sessions, dependent: :destroy
       - has_many :invitations, foreign_key: :invited_by_id
       - generates_token_for :password_reset, expires_in: 15.minutes
       - validates email_address presence, uniqueness (case insensitive), format

    4. Create Session model (api/app/models/session.rb):
       - belongs_to :user
       - has_secure_token :token
       - user_agent:string, ip_address:string
       - Add index on token (unique)

    5. Create Current model (api/app/models/current.rb):
       - attribute :session
       - attribute :user

    6. Create Invitation model (api/app/models/invitation.rb):
       - email:string (not null, unique)
       - invited_by:references (User)
       - accepted_at:datetime
       - generates_token_for :invitation, expires_in: 7.days do; accepted_at; end
       - validates email presence, uniqueness, format
       - scope :pending (where accepted_at: nil)

    7. Run migrations:
       ```bash
       rails db:create db:migrate
       ```

    8. Create seed for admin user:
       - In db/seeds.rb, create admin user with email from ENV['ADMIN_EMAIL'] or 'admin@influenza.local'
       - Password from ENV['ADMIN_PASSWORD'] or 'password123'
       - admin: true
  </action>
  <verify>
    ```bash
    cd api
    rails runner "puts User.columns.map(&:name).join(', ')"
    rails runner "puts Session.columns.map(&:name).join(', ')"
    rails runner "puts Invitation.columns.map(&:name).join(', ')"
    ```
    Output shows expected columns for each model.
  </verify>
  <done>
    - Rails API project exists in /api directory
    - User model has email_address, password_digest, admin columns, has_secure_password
    - Session model has token, user_id columns, has_secure_token
    - Invitation model has email, invited_by_id, accepted_at columns, generates_token_for
    - Database created and migrated
    - CORS configured for frontend
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement authentication concern and API controllers</name>
  <files>
    api/app/controllers/concerns/authentication.rb
    api/app/controllers/application_controller.rb
    api/app/controllers/api/v1/sessions_controller.rb
    api/app/controllers/api/v1/users_controller.rb
    api/app/controllers/api/v1/passwords_controller.rb
    api/app/controllers/api/v1/invitations_controller.rb
    api/app/mailers/passwords_mailer.rb
    api/app/mailers/invitations_mailer.rb
    api/config/routes.rb
  </files>
  <action>
    1. Create Authentication concern (api/app/controllers/concerns/authentication.rb):
       - Include before_action :require_authentication
       - resume_session: find session via authenticate_with_http_token, set Current.session and Current.user
       - request_authentication: render json { error: "Unauthorized" }, status: :unauthorized
       - authenticated? helper returns Current.user.present?

    2. Update ApplicationController:
       - include Authentication concern

    3. Create SessionsController (api/app/controllers/api/v1/sessions_controller.rb):
       - skip_before_action :require_authentication
       - create: Find user by email_address, authenticate password, create session, return { token:, user: }
       - destroy: Current.session.destroy, head :no_content

    4. Create UsersController (api/app/controllers/api/v1/users_controller.rb):
       - skip_before_action :require_authentication, only: [:create]
       - create: Accept invite_token param, verify via Invitation.find_by_token_for(:invitation, token)
         - If valid and not accepted: create user with email from invitation, mark invitation accepted_at = Time.current
         - Auto-login by creating session and returning token
         - If invalid token: render error 422
       - show: Return Current.user info (protected endpoint)

    5. Create PasswordsController (api/app/controllers/api/v1/passwords_controller.rb):
       - skip_before_action :require_authentication
       - create: Find user by email, if found generate password_reset token, send email (deliver_later)
         - Always return 200 (don't reveal if email exists)
       - update: Find user via find_by_token_for(:password_reset, token), update password
         - Destroy all user sessions on password change
         - Return 200 on success, 422 on invalid token

    6. Create InvitationsController (api/app/controllers/api/v1/invitations_controller.rb):
       - before_action :require_admin (except verify)
       - skip_before_action :require_authentication, only: [:verify]
       - create: Create invitation with invited_by: Current.user, generate token, send email
       - verify: Find by token, return email if valid, error if not
       - Add require_admin private method: render unauthorized unless Current.user&.admin?

    7. Create PasswordsMailer:
       - reset(user, token) method
       - Template with reset link: ENV['FRONTEND_URL']/reset-password?token=#{token}

    8. Create InvitationsMailer:
       - invite(invitation, token) method
       - Template with signup link: ENV['FRONTEND_URL']/signup?token=#{token}

    9. Configure routes (config/routes.rb):
       ```ruby
       Rails.application.routes.draw do
         namespace :api do
           namespace :v1 do
             resource :session, only: [:create, :destroy]
             resources :users, only: [:create, :show]
             resource :password, only: [:create, :update]
             resources :invitations, only: [:create] do
               collection do
                 get :verify
               end
             end
           end
         end

         get "health", to: proc { [200, {}, ["OK"]] }
       end
       ```

    10. Configure Action Mailer for development (config/environments/development.rb):
        - Use letter_opener or log delivery method
  </action>
  <verify>
    ```bash
    cd api
    rails routes | grep api/v1
    rails runner "puts PasswordsMailer.instance_methods(false)"
    rails runner "puts InvitationsMailer.instance_methods(false)"
    ```
    Routes show all expected endpoints. Mailers have expected methods.
  </verify>
  <done>
    - Authentication concern validates Bearer token and sets Current.user
    - Sessions endpoint: POST creates session, DELETE destroys session
    - Users endpoint: POST creates user via invite token, GET /users/:id returns user info
    - Passwords endpoint: POST sends reset email, PUT resets password with token
    - Invitations endpoint: POST creates invite (admin only), GET verify checks token
    - Routes configured under /api/v1 namespace
    - Health check endpoint at /health
    - Mailers configured for password reset and invitations
  </done>
</task>

<task type="auto">
  <name>Task 3: Test authentication flows end-to-end</name>
  <files>
    api/db/seeds.rb
  </files>
  <action>
    1. Ensure admin user exists via seed or runner:
       ```bash
       cd api
       rails db:seed || rails runner "User.find_or_create_by(email_address: 'admin@influenza.local') { |u| u.password = 'password123'; u.admin = true }"
       ```

    2. Start Rails server:
       ```bash
       rails s -p 3000 &
       sleep 3
       ```

    3. Test login flow:
       ```bash
       # Should return 401 for bad credentials
       curl -s -X POST http://localhost:3000/api/v1/session \
         -H "Content-Type: application/json" \
         -d '{"email":"admin@influenza.local","password":"wrong"}' | jq .

       # Should return 200 + token for valid credentials
       curl -s -X POST http://localhost:3000/api/v1/session \
         -H "Content-Type: application/json" \
         -d '{"email":"admin@influenza.local","password":"password123"}' | jq .
       ```

    4. Test protected endpoint:
       ```bash
       # Get token first
       TOKEN=$(curl -s -X POST http://localhost:3000/api/v1/session \
         -H "Content-Type: application/json" \
         -d '{"email":"admin@influenza.local","password":"password123"}' | jq -r .token)

       # Should return 401 without token
       curl -s http://localhost:3000/api/v1/users/1 | jq .

       # Should return user with token
       curl -s http://localhost:3000/api/v1/users/1 \
         -H "Authorization: Bearer $TOKEN" | jq .
       ```

    5. Test invitation flow:
       ```bash
       # Create invitation (requires admin token)
       INVITE=$(curl -s -X POST http://localhost:3000/api/v1/invitations \
         -H "Content-Type: application/json" \
         -H "Authorization: Bearer $TOKEN" \
         -d '{"email":"newuser@test.com"}' | jq -r .token)

       # Verify invitation token
       curl -s "http://localhost:3000/api/v1/invitations/verify?token=$INVITE" | jq .

       # Create user with invitation
       curl -s -X POST http://localhost:3000/api/v1/users \
         -H "Content-Type: application/json" \
         -d "{\"invite_token\":\"$INVITE\",\"password\":\"newpassword123\"}" | jq .
       ```

    6. Test password reset flow:
       ```bash
       # Request reset (always 200)
       curl -s -X POST http://localhost:3000/api/v1/password \
         -H "Content-Type: application/json" \
         -d '{"email":"admin@influenza.local"}' | jq .

       # Check logs for reset token (in development mode)
       ```

    7. Stop server:
       ```bash
       pkill -f "rails s" || true
       ```
  </action>
  <verify>
    All curl commands in action return expected status codes:
    - Bad login: 401
    - Good login: 200 with token
    - Protected without auth: 401
    - Protected with auth: 200 with user data
    - Create invitation: 201 with token
    - Verify invitation: 200 with email
    - Create user via invite: 201 with token
    - Password reset request: 200
  </verify>
  <done>
    - Admin user exists and can login
    - Login returns session token
    - Protected endpoints require valid token
    - Admin can create invitations
    - Invitation tokens can be verified
    - New users can signup with valid invitation token
    - Password reset endpoint accepts email and returns success
    - Rails API is fully functional for all Phase 1 auth requirements
  </done>
</task>

</tasks>

<verification>
After completing all tasks:

1. Rails server starts without errors: `cd api && rails s -p 3000`
2. Database has User, Session, Invitation tables
3. All auth endpoints respond correctly:
   - POST /api/v1/session (login)
   - DELETE /api/v1/session (logout)
   - POST /api/v1/users (signup via invite)
   - GET /api/v1/users/:id (protected)
   - POST /api/v1/password (request reset)
   - PUT /api/v1/password (reset with token)
   - POST /api/v1/invitations (admin create)
   - GET /api/v1/invitations/verify (check token)
4. Health check responds: GET /health -> 200 OK
</verification>

<success_criteria>
- Rails 8 API running on port 3000
- PostgreSQL database with User, Session, Invitation models
- Token-based authentication working (Bearer token in Authorization header)
- Admin can login and create invitations
- New users can signup via invitation token
- Password reset flow functional (mailer configured)
- CORS configured for frontend access
- All endpoints versioned under /api/v1/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
