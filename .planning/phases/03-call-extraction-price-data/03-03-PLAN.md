---
phase: 03-call-extraction-price-data
plan: 03
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - api/app/services/prices/base_adapter.rb
  - api/app/services/prices/coingecko_adapter.rb
  - api/app/services/prices/yahoo_finance_adapter.rb
  - api/app/services/prices/price_fetcher.rb
  - api/app/jobs/fetch_price_data_job.rb
  - api/app/jobs/fetch_all_prices_job.rb
  - api/config/recurring.yml
autonomous: true
user_setup:
  - service: coingecko
    why: "Crypto price data for chart rendering"
    env_vars:
      - name: COINGECKO_API_KEY
        source: "CoinGecko -> Developer Dashboard (https://www.coingecko.com/en/api/pricing) -> Demo plan (free) -> API key"

must_haves:
  truths:
    - "CoinGecko adapter fetches historical OHLCV data for crypto assets and stores as PriceSnapshots"
    - "Yahoo Finance adapter fetches historical OHLCV data for macro assets and stores as PriceSnapshots"
    - "PriceFetcher selects the correct adapter based on asset.asset_class (crypto vs macro)"
    - "Price adapters are swappable without changing calling code"
    - "Price fetching runs automatically on a daily schedule"
    - "Duplicate price data is prevented via upsert on [asset_id, timestamp]"
  artifacts:
    - path: "api/app/services/prices/base_adapter.rb"
      provides: "Abstract adapter interface with #historical method"
      contains: "NotImplementedError"
    - path: "api/app/services/prices/coingecko_adapter.rb"
      provides: "CoinGecko API integration for crypto prices"
      contains: "api.coingecko.com"
    - path: "api/app/services/prices/yahoo_finance_adapter.rb"
      provides: "Yahoo Finance API integration for macro prices"
      contains: "query1.finance.yahoo.com"
    - path: "api/app/services/prices/price_fetcher.rb"
      provides: "Adapter selector based on asset_class"
      contains: "ADAPTERS"
  key_links:
    - from: "api/app/services/prices/price_fetcher.rb"
      to: "api/app/services/prices/coingecko_adapter.rb"
      via: "ADAPTERS hash mapping crypto to CoinGecko"
      pattern: "crypto.*CoingeckoAdapter"
    - from: "api/app/services/prices/price_fetcher.rb"
      to: "api/app/services/prices/yahoo_finance_adapter.rb"
      via: "ADAPTERS hash mapping macro to Yahoo"
      pattern: "macro.*YahooFinanceAdapter"
    - from: "api/app/jobs/fetch_price_data_job.rb"
      to: "api/app/services/prices/price_fetcher.rb"
      via: "Fetcher invocation in perform"
      pattern: "PriceFetcher"
---

<objective>
Build the modular price data pipeline: swappable adapters for CoinGecko (crypto) and Yahoo Finance (macro), a fetcher that routes to the correct adapter, and background jobs for scheduled price updates.

Purpose: Price data is needed for Phase 4 chart rendering. The adapter pattern ensures providers can be swapped without code changes (PRCE-01 requirement).
Output: Price adapter services, background jobs, recurring schedule for daily price updates.
</objective>

<execution_context>
@/Users/superuser/.claude/get-shit-done/workflows/execute-plan.md
@/Users/superuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-call-extraction-price-data/03-RESEARCH.md
@api/app/models/asset.rb
@api/app/models/price_snapshot.rb
@api/config/recurring.yml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create price adapter services with CoinGecko and Yahoo Finance implementations</name>
  <files>
    api/app/services/prices/base_adapter.rb
    api/app/services/prices/coingecko_adapter.rb
    api/app/services/prices/yahoo_finance_adapter.rb
    api/app/services/prices/price_fetcher.rb
  </files>
  <action>
    1. Create `api/app/services/prices/base_adapter.rb`:
       - Module `Prices`, class `BaseAdapter`
       - Define `historical(asset, days:)` method that raises NotImplementedError
       - The method should return an array of hashes: `[{ timestamp:, open:, high:, low:, close:, volume: }, ...]`
       - Include a `save_snapshots(asset, price_data)` method that bulk upserts PriceSnapshot records:
         - Use `PriceSnapshot.upsert_all(records, unique_by: [:asset_id, :timestamp])` for efficiency
         - Filter out entries with nil close price
         - Log count of saved snapshots

    2. Create `api/app/services/prices/coingecko_adapter.rb`:
       - Class `Prices::CoingeckoAdapter < Prices::BaseAdapter`
       - BASE_URL = "https://api.coingecko.com/api/v3"
       - `historical(asset, days: 365)`:
         - Use asset.coingecko_id for the coin ID
         - Return empty array if coingecko_id is blank
         - HTTParty.get "#{BASE_URL}/coins/#{asset.coingecko_id}/market_chart"
         - Query params: { vs_currency: "usd", days: days }
         - Headers: { "x-cg-demo-api-key" => ENV["COINGECKO_API_KEY"], "Accept" => "application/json" }
         - Timeout: 15 seconds
         - Parse response: data["prices"] is array of [timestamp_ms, price]
         - CoinGecko market_chart only returns close prices (not OHLCV). Map to: { timestamp: Time.at(ts_ms/1000).utc, close: price, open: nil, high: nil, low: nil, volume: nil }
         - For OHLCV data, use `/coins/{id}/ohlc` endpoint instead: query { vs_currency: "usd", days: days }. Returns array of [timestamp_ms, open, high, low, close]. Use this endpoint if available.
         - Actually, use the `/coins/{id}/ohlc` endpoint since we need OHLC for charts. It returns [timestamp, open, high, low, close] arrays. No volume in this endpoint, set volume to nil.
         - Call save_snapshots to persist
         - Rescue HTTParty::Error and Net::OpenTimeout -- log error, return empty array
       - Handle rate limiting: if response code is 429, log warning and return empty array (job retry will handle it)

    3. Create `api/app/services/prices/yahoo_finance_adapter.rb`:
       - Class `Prices::YahooFinanceAdapter < Prices::BaseAdapter`
       - `historical(asset, days: 365)`:
         - Use asset.yahoo_ticker for the ticker symbol
         - Return empty array if yahoo_ticker is blank
         - Calculate period1 (days.ago.to_i) and period2 (Time.now.to_i)
         - HTTParty.get "https://query1.finance.yahoo.com/v8/finance/chart/#{CGI.escape(asset.yahoo_ticker)}"
         - Query params: { period1: period1, period2: period2, interval: "1d", includeAdjustedClose: true }
         - Headers: { "User-Agent" => "Mozilla/5.0 (compatible; Influenza/1.0)" }
         - Timeout: 15 seconds
         - Parse response: dig into chart -> result -> [0]
         - Extract timestamps array and indicators -> quote -> [0] (has open, high, low, close, volume arrays)
         - Map each index to: { timestamp: Time.at(ts).utc, open: quotes["open"][i], high: quotes["high"][i], low: quotes["low"][i], close: quotes["close"][i], volume: quotes["volume"][i] }
         - Skip entries where close is nil
         - Call save_snapshots to persist
         - Rescue HTTParty::Error, Net::OpenTimeout, JSON::ParserError -- log error, return empty array
         - Handle 401/403/429 gracefully with logging

    4. Create `api/app/services/prices/price_fetcher.rb`:
       - Class `Prices::PriceFetcher`
       - ADAPTERS = { "crypto" => Prices::CoingeckoAdapter, "macro" => Prices::YahooFinanceAdapter }.freeze
       - Class method `fetch(asset, days: 365)`:
         - Look up adapter class from ADAPTERS using asset.asset_class
         - Raise ArgumentError if unknown asset_class
         - Instantiate adapter and call historical(asset, days: days)
         - Return the result
       - Class method `adapter_for(asset)`:
         - Returns the adapter instance for the given asset (useful for testing/inspection)
  </action>
  <verify>
    Run `ruby -c api/app/services/prices/base_adapter.rb` -- syntax OK.
    Run `ruby -c api/app/services/prices/coingecko_adapter.rb` -- syntax OK.
    Run `ruby -c api/app/services/prices/yahoo_finance_adapter.rb` -- syntax OK.
    Run `ruby -c api/app/services/prices/price_fetcher.rb` -- syntax OK.
    Run `bin/rails runner "puts Prices::PriceFetcher::ADAPTERS.keys.sort.join(', ')"` -- should print "crypto, macro".
    Run `bin/rails runner "puts Prices::BaseAdapter.new.respond_to?(:historical)"` -- should print true.
  </verify>
  <done>Four price service classes created: BaseAdapter (interface with save_snapshots bulk upsert), CoingeckoAdapter (OHLC endpoint for crypto), YahooFinanceAdapter (v8/chart for macro), PriceFetcher (adapter selector by asset_class). All adapters share common save_snapshots logic and handle errors gracefully.</done>
</task>

<task type="auto">
  <name>Task 2: Create price fetch background jobs and recurring schedule</name>
  <files>
    api/app/jobs/fetch_price_data_job.rb
    api/app/jobs/fetch_all_prices_job.rb
    api/config/recurring.yml
  </files>
  <action>
    1. Create `api/app/jobs/fetch_price_data_job.rb`:
       - Class FetchPriceDataJob < ApplicationJob
       - queue_as :prices
       - retry_on Faraday::Error, HTTParty::Error, Net::OpenTimeout, wait: :polynomially_longer, attempts: 3
       - discard_on ActiveRecord::RecordNotFound
       - `perform(asset_id, days: 365)`:
         - Find asset by ID
         - Call `Prices::PriceFetcher.fetch(asset, days: days)`
         - Log: "Fetched price data for #{asset.symbol} (#{asset.asset_class})"

    2. Create `api/app/jobs/fetch_all_prices_job.rb`:
       - Class FetchAllPricesJob < ApplicationJob
       - queue_as :prices
       - `perform`:
         - Find all assets that have at least one Call associated (only fetch prices for assets that have been called)
         - Use `Asset.joins(:calls).distinct`
         - For each asset, determine days to fetch:
           - If asset has NO price_snapshots yet: fetch 365 days (initial load)
           - If asset HAS price_snapshots: fetch 7 days (incremental update)
         - Enqueue `FetchPriceDataJob.perform_later(asset.id, days: days)` for each
         - Add 2-second delay between enqueues for CoinGecko rate limiting: use `FetchPriceDataJob.set(wait: index * 2.seconds).perform_later(asset.id, days: days)`
         - Log: "Enqueued price fetch for #{count} assets"

    3. Update `api/config/recurring.yml`:
       - Add to production section:
         ```
         fetch_all_prices:
           class: FetchAllPricesJob
           schedule: every day at 6am
           queue: prices
         ```
       - Add to development section:
         ```
         fetch_all_prices:
           class: FetchAllPricesJob
           schedule: every hour
         ```
       - Daily at 6am is sufficient for price data (historical data doesn't change, only need new daily candles).
       - Do NOT remove or modify existing entries (sync_youtube_channels, sync_twitter_accounts, extract_all_pending_calls).
  </action>
  <verify>
    Run `ruby -c api/app/jobs/fetch_price_data_job.rb` -- syntax OK.
    Run `ruby -c api/app/jobs/fetch_all_prices_job.rb` -- syntax OK.
    Run `bin/rails runner "puts FetchPriceDataJob.queue_name"` -- should print "prices".
    Run `bin/rails runner "puts FetchAllPricesJob.queue_name"` -- should print "prices".
    Verify recurring.yml is valid YAML and contains fetch_all_prices in both environments.
    Verify recurring.yml still contains all prior entries (sync_youtube, sync_twitter, extract_all_pending_calls).
  </verify>
  <done>Two background jobs created: FetchPriceDataJob (per-asset with retry on network errors), FetchAllPricesJob (batch dispatcher for assets with calls, staggered 2s apart for rate limiting). Recurring schedule: daily at 6am in production, hourly in development. Only fetches prices for assets that have associated calls.</done>
</task>

</tasks>

<verification>
- All four service files pass syntax check
- All two job files pass syntax check
- recurring.yml is valid YAML with price jobs in both environments
- PriceFetcher routes crypto to CoingeckoAdapter and macro to YahooFinanceAdapter
- BaseAdapter defines save_snapshots with upsert_all for deduplication
- FetchAllPricesJob only fetches for assets with calls (not all 15 seeded assets)
</verification>

<success_criteria>
- BaseAdapter defines common interface (historical method) and shared save_snapshots logic
- CoingeckoAdapter fetches from /coins/{id}/ohlc with API key auth, handles 429 rate limits
- YahooFinanceAdapter fetches from v8/chart with User-Agent header, handles errors gracefully
- PriceFetcher.fetch(asset) selects correct adapter based on asset_class
- Adapters are swappable: changing ADAPTERS hash is the only change needed to swap providers (PRCE-01)
- Price data stored as PriceSnapshots with upsert preventing duplicates
- Daily recurring schedule fetches prices for all called assets
- Staggered job enqueueing respects CoinGecko rate limits (30 calls/min)
</success_criteria>

<output>
After completion, create `.planning/phases/03-call-extraction-price-data/03-03-SUMMARY.md`
</output>
