---
phase: 03-call-extraction-price-data
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - api/db/migrate/TIMESTAMP_create_assets.rb
  - api/db/migrate/TIMESTAMP_create_calls.rb
  - api/db/migrate/TIMESTAMP_create_price_snapshots.rb
  - api/db/migrate/TIMESTAMP_add_extraction_status_to_contents.rb
  - api/app/models/asset.rb
  - api/app/models/call.rb
  - api/app/models/price_snapshot.rb
  - api/app/models/content.rb
  - api/app/models/influencer.rb
  - api/db/seeds.rb
  - api/db/schema.rb
autonomous: true

must_haves:
  truths:
    - "Asset, Call, and PriceSnapshot tables exist with correct columns and indexes"
    - "Content records have extraction_status (default: pending) and calls_extracted_at columns"
    - "Call belongs_to content, influencer, and asset with proper foreign keys"
    - "Supported assets are seeded (BTC, ETH, SOL, NASDAQ, SP500, etc.)"
  artifacts:
    - path: "api/app/models/asset.rb"
      provides: "Asset model with symbol, name, asset_class, coingecko_id, yahoo_ticker"
      contains: "validates :symbol"
    - path: "api/app/models/call.rb"
      provides: "Call model with direction, confidence, quote, reasoning, called_at"
      contains: "belongs_to :asset"
    - path: "api/app/models/price_snapshot.rb"
      provides: "PriceSnapshot model with OHLCV data"
      contains: "belongs_to :asset"
    - path: "api/db/seeds.rb"
      provides: "Seed data for supported assets"
      contains: "Asset.find_or_create_by"
  key_links:
    - from: "api/app/models/call.rb"
      to: "api/app/models/content.rb"
      via: "belongs_to :content"
      pattern: "belongs_to :content"
    - from: "api/app/models/call.rb"
      to: "api/app/models/influencer.rb"
      via: "belongs_to :influencer"
      pattern: "belongs_to :influencer"
    - from: "api/app/models/influencer.rb"
      to: "api/app/models/call.rb"
      via: "has_many :calls"
      pattern: "has_many :calls"
---

<objective>
Create the data foundation for Phase 3: Asset, Call, and PriceSnapshot models with migrations, add extraction tracking columns to Content, and seed the supported asset list.

Purpose: All Phase 3 services (call extraction, price fetching) depend on these models existing. This is the shared foundation.
Output: Three new database tables (assets, calls, price_snapshots), updated contents table, seeded asset data.
</objective>

<execution_context>
@/Users/superuser/.claude/get-shit-done/workflows/execute-plan.md
@/Users/superuser/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-call-extraction-price-data/03-RESEARCH.md
@api/db/schema.rb
@api/app/models/content.rb
@api/app/models/influencer.rb
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Asset, Call, and PriceSnapshot migrations and models</name>
  <files>
    api/db/migrate/TIMESTAMP_create_assets.rb
    api/db/migrate/TIMESTAMP_create_calls.rb
    api/db/migrate/TIMESTAMP_create_price_snapshots.rb
    api/db/migrate/TIMESTAMP_add_extraction_status_to_contents.rb
    api/app/models/asset.rb
    api/app/models/call.rb
    api/app/models/price_snapshot.rb
    api/app/models/content.rb
    api/app/models/influencer.rb
  </files>
  <action>
    Generate four migrations using `bin/rails generate migration`:

    1. **CreateAssets** migration:
       - symbol: string, null: false (unique index)
       - name: string, null: false
       - asset_class: string, null: false ("crypto" or "macro")
       - coingecko_id: string (nullable, for crypto assets)
       - yahoo_ticker: string (nullable, for macro assets)
       - aliases: jsonb, default: []
       - timestamps
       - Add unique index on :symbol and index on :asset_class

    2. **CreateCalls** migration:
       - content_id: references, null: false, foreign_key: true
       - influencer_id: references, null: false, foreign_key: true
       - asset_id: references, null: false, foreign_key: true
       - direction: string, null: false ("bullish" or "bearish")
       - confidence: decimal, null: false (precision: 5, scale: 4 -- range 0.0000 to 1.0000)
       - quote: text (nullable)
       - reasoning: text (nullable)
       - called_at: datetime, null: false
       - timestamps
       - Add composite indexes: [:influencer_id, :called_at], [:asset_id, :called_at]
       - Add index on :direction

    3. **CreatePriceSnapshots** migration:
       - asset_id: references, null: false, foreign_key: true
       - timestamp: datetime, null: false
       - open: decimal, precision: 20, scale: 8 (nullable)
       - high: decimal, precision: 20, scale: 8 (nullable)
       - low: decimal, precision: 20, scale: 8 (nullable)
       - close: decimal, precision: 20, scale: 8, null: false
       - volume: bigint (nullable)
       - timestamps
       - Add unique composite index on [:asset_id, :timestamp]
       - Add index on :timestamp

    4. **AddExtractionStatusToContents** migration:
       - Add column :calls_extracted_at, :datetime (nullable)
       - Add column :extraction_status, :string, default: "pending"
       - Add index on :extraction_status
       - Add index on :calls_extracted_at

    Run `bin/rails db:migrate` after creating all migrations.

    Create models:

    **api/app/models/asset.rb:**
    - validates :symbol, presence: true, uniqueness: true
    - validates :name, presence: true
    - validates :asset_class, presence: true, inclusion: { in: %w[crypto macro] }
    - has_many :calls, dependent: :destroy
    - has_many :price_snapshots, dependent: :destroy
    - scope :crypto, -> { where(asset_class: "crypto") }
    - scope :macro, -> { where(asset_class: "macro") }

    **api/app/models/call.rb:**
    - belongs_to :content
    - belongs_to :influencer
    - belongs_to :asset
    - validates :direction, presence: true, inclusion: { in: %w[bullish bearish] }
    - validates :confidence, presence: true, numericality: { greater_than_or_equal_to: 0, less_than_or_equal_to: 1 }
    - validates :called_at, presence: true
    - scope :bullish, -> { where(direction: "bullish") }
    - scope :bearish, -> { where(direction: "bearish") }
    - scope :high_confidence, -> { where("confidence >= ?", 0.7) }
    - scope :recent, -> { order(called_at: :desc) }

    **api/app/models/price_snapshot.rb:**
    - belongs_to :asset
    - validates :timestamp, presence: true, uniqueness: { scope: :asset_id }
    - validates :close, presence: true
    - scope :chronological, -> { order(timestamp: :asc) }
    - scope :for_range, ->(start_time, end_time) { where(timestamp: start_time..end_time) }

    **Update api/app/models/content.rb:** Add `has_many :calls, dependent: :destroy`
    **Update api/app/models/influencer.rb:** Add `has_many :calls, dependent: :destroy`
  </action>
  <verify>
    Run `bin/rails db:migrate` successfully.
    Run `bin/rails runner "puts Asset.column_names.sort.join(', ')"` -- should include asset_class, coingecko_id, name, symbol, yahoo_ticker.
    Run `bin/rails runner "puts Call.column_names.sort.join(', ')"` -- should include asset_id, called_at, confidence, content_id, direction, influencer_id, quote, reasoning.
    Run `bin/rails runner "puts PriceSnapshot.column_names.sort.join(', ')"` -- should include asset_id, close, high, low, open, timestamp, volume.
    Run `bin/rails runner "puts Content.column_names.include?('extraction_status')"` -- should print true.
  </verify>
  <done>All four migrations applied, three new models created with validations and associations, Content and Influencer updated with has_many :calls</done>
</task>

<task type="auto">
  <name>Task 2: Seed supported assets</name>
  <files>api/db/seeds.rb</files>
  <action>
    Add asset seed data to api/db/seeds.rb. Use `Asset.find_or_create_by!(symbol: ...)` so seeds are idempotent.

    Seed the following assets (from the research-defined supported list):

    **Crypto assets (asset_class: "crypto"):**
    - BTC / Bitcoin / coingecko_id: "bitcoin"
    - ETH / Ethereum / coingecko_id: "ethereum"
    - SOL / Solana / coingecko_id: "solana"
    - XRP / XRP / coingecko_id: "ripple"
    - ADA / Cardano / coingecko_id: "cardano"
    - DOT / Polkadot / coingecko_id: "polkadot"
    - AVAX / Avalanche / coingecko_id: "avalanche-2"
    - LINK / Chainlink / coingecko_id: "chainlink"
    - MATIC / Polygon / coingecko_id: "matic-network"
    - DOGE / Dogecoin / coingecko_id: "dogecoin"
    - SHIB / Shiba Inu / coingecko_id: "shiba-inu"

    **Macro assets (asset_class: "macro"):**
    - NASDAQ / NASDAQ Composite / yahoo_ticker: "^IXIC"
    - SP500 / S&P 500 / yahoo_ticker: "^GSPC"
    - DXY / US Dollar Index / yahoo_ticker: "DX-Y.NYB"
    - GOLD / Gold / yahoo_ticker: "GC=F"

    Preserve any existing seed content in the file (append, don't overwrite prior sections). Wrap the new section in a clear comment block: `# === Phase 3: Seed supported assets ===`.

    Run `bin/rails db:seed` to execute.
  </action>
  <verify>
    Run `bin/rails db:seed` without errors.
    Run `bin/rails runner "puts Asset.count"` -- should print 15.
    Run `bin/rails runner "puts Asset.crypto.count"` -- should print 11.
    Run `bin/rails runner "puts Asset.macro.count"` -- should print 4.
    Run `bin/rails runner "puts Asset.find_by(symbol: 'BTC').coingecko_id"` -- should print "bitcoin".
    Run `bin/rails runner "puts Asset.find_by(symbol: 'NASDAQ').yahoo_ticker"` -- should print "^IXIC".
  </verify>
  <done>15 supported assets seeded (11 crypto, 4 macro) with correct coingecko_id and yahoo_ticker mappings, idempotent via find_or_create_by</done>
</task>

</tasks>

<verification>
- `bin/rails db:migrate:status` shows all four migrations as "up"
- `bin/rails runner "Call.new(content: Content.first, influencer: Influencer.first, asset: Asset.first, direction: 'bullish', confidence: 0.9, called_at: Time.current).valid?"` returns true (if test data exists)
- `bin/rails runner "Asset.count"` returns 15
- Schema file reflects all new tables and columns
</verification>

<success_criteria>
- Asset, Call, PriceSnapshot tables exist with all specified columns and indexes
- Content table has extraction_status (default: "pending") and calls_extracted_at columns
- Model validations and associations are correctly defined
- 15 assets seeded with correct provider IDs (coingecko_id for crypto, yahoo_ticker for macro)
- All seeds are idempotent (can run multiple times safely)
</success_criteria>

<output>
After completion, create `.planning/phases/03-call-extraction-price-data/03-01-SUMMARY.md`
</output>
